name: Bootstrap Tracking

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  projects: write

jobs:
  create:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Install gh and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq
      - name: Create issues from ops/issues.json
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          existing=$(gh issue list --limit 200 --json title | jq -r '.[].title')
          jq -c '.[]' ops/issues.json | while read -r item; do
            title=$(echo "$item" | jq -r '.title')
            body=$(echo "$item" | jq -r '.body')
            labels=$(echo "$item" | jq -r '.labels | join(",")')
            if echo "$existing" | grep -Fxq "$title"; then
              echo "Issue exists: $title"
            else
              echo "Creating: $title"
              gh issue create --title "$title" --body "$body" ${labels:+--label "$labels"}
            fi
          done
      - name: Try to create classic Project board (best-effort)
        run: |
          set -euo pipefail
          # Create project (ignore failure if disabled)
          proj_id=$(gh api -H "Accept: application/vnd.github.inertia-preview+json" \
            repos/${GITHUB_REPOSITORY}/projects -f name='Roadmap' -f body='Auto-created project board' 2>/dev/null | jq -r '.id' || true)
          if [ -n "$proj_id" ] && [ "$proj_id" != "null" ]; then
            echo "Project created: $proj_id"
            # Columns
            for col in "Backlog" "In Progress" "Done"; do
              gh api -H "Accept: application/vnd.github.inertia-preview+json" \
                projects/$proj_id/columns -f name="$col" >/dev/null
            done
          else
            echo "Skipping project creation (not supported or permissions)"
          fi
